# This workflow runs when a change is made to emulation-system or the sample files.
# It runs all the sample files and ensure that they output a compose file.

name: 'Test Sample Files'

on:
  push:
    branches:
      - 'main'
      - 'release-*'

  pull_request:
    paths:
      - 'emulation_system/**'
      - 'samples/**'
      - '.github/workflows/test-samples-files.yaml'
      - '.github/actions/**'
      - 'scripts/makefile/helper_scripts/**'
      - 'docker/**'
      - './Makefile'
  workflow_dispatch:

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-test:
    name: Run All Sample Files
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          path: opentrons-emulation
          ref: ${{ github.sha }}

      - name: Checkout Monorepo
        uses: actions/checkout@v3
        with:
          repository: Opentrons/opentrons
          path: opentrons

      - name: Checkout ot3-firmware
        uses: actions/checkout@v3
        with:
          repository: Opentrons/ot3-firmware
          path: ot3-firmware

      - name: Checkout opentrons-modules
        uses: actions/checkout@v3
        with:
          repository: Opentrons/opentrons-modules
          path: opentrons-modules

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Setup Project
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          make setup
        working-directory: ./opentrons-emulation

      - name: Test All Samples
        run: make test-samples
        working-directory: ./opentrons-emulation
